#include <vcl.h>
#pragma hdrstop

#include "Main.h"
#include "LexicalBlock.h"
#include "LexicalBlock.cpp"

#pragma package(smart_init)
#pragma resource "*.dfm"

TMainForm *MainForm;

__fastcall TMainForm::TMainForm(TComponent* Owner)
    : TForm(Owner)
{
    lexer = new LexicalBlock();
    SetupGrids();

    Caption = "Lexical Block";
    Width = 900;
    Height = 700;
    Position = poScreenCenter;

    MemoSource->Text = "";
    MemoSource->Font->Name = "Courier New";
    MemoSource->Font->Size = 10;

    StatusBar->SimpleText = "Ready";
}

__fastcall TMainForm::~TMainForm()
{
    delete lexer;
}

void __fastcall TMainForm::SetupGrids()
{
	GridLexems->ColCount = 4;
    GridLexems->RowCount = 1;
    GridLexems->FixedRows = 0;
    GridLexems->Cells[0][0] = "#";
    GridLexems->Cells[1][0] = "Lexem";
    GridLexems->Cells[2][0] = "Class";
    GridLexems->Cells[3][0] = "Position";
    GridLexems->ColWidths[0] = 40;
    GridLexems->ColWidths[1] = 150;
    GridLexems->ColWidths[2] = 120;
    GridLexems->ColWidths[3] = 80;

    GridIdentifiers->ColCount = 4;
    GridIdentifiers->RowCount = 1;
    GridIdentifiers->FixedRows = 0;
    GridIdentifiers->Cells[0][0] = "#";
    GridIdentifiers->Cells[1][0] = "Identifier";
    GridIdentifiers->Cells[2][0] = "Type";
    GridIdentifiers->Cells[3][0] = "Used";
    GridIdentifiers->ColWidths[0] = 40;
    GridIdentifiers->ColWidths[1] = 150;
    GridIdentifiers->ColWidths[2] = 100;
    GridIdentifiers->ColWidths[3] = 80;

    GridConstants->ColCount = 4;
    GridConstants->RowCount = 1;
    GridConstants->FixedRows = 0;
    GridConstants->Cells[0][0] = "#";
    GridConstants->Cells[1][0] = "Constant";
    GridConstants->Cells[2][0] = "Value";
    GridConstants->Cells[3][0] = "Used";
    GridConstants->ColWidths[0] = 40;
    GridConstants->ColWidths[1] = 100;
    GridConstants->ColWidths[2] = 80;
    GridConstants->ColWidths[3] = 80;
}

UnicodeString TMainForm::GetClassName(int classId)
{
    switch(classId) {
        case 1: return "Identifier";
        case 2: return "Keyword";
        case 3: return "Integer";
        case 4: return "Delimiter/Operator";
        default: return "Unknown";
    }
}

void __fastcall TMainForm::ButtonLoadExampleClick(TObject *Sender)
{
    const char* example =
		"d=2*3+1;\n"
		"a=3+2*d;\n"
		"c=2*d+3*a;\n"
		"ЕСЛИ(d>c)\n"
		"    a=d*2;\n"
		"ИНАЧЕ\n"
		"    a=d;\n"
		"КОНЕЦ_ЕСЛИ\n"
		"i=1;\n"
		"ПОКА(i<10)\n"
		"    i=i+1;\n"
        "КОНЕЦ_ПОКА\n";

	MemoSource->Text = 		L"d=2*3+1;\n"
		L"a=3+2*d;\n"
		L"c=2*d+3*a;\n"
		L"ЕСЛИ(d>c)\n"
		L"    a=d*2;\n"
		L"ИНАЧЕ\n"
		L"    a=d;\n"
		L"КОНЕЦ_ЕСЛИ\n"
		L"i=1;\n"
		L"ПОКА(i<10)\n"
		L"    i=i+1;\n"
		L"КОНЕЦ_ПОКА\n";
    StatusBar->SimpleText = "Example program loaded";
}

void __fastcall TMainForm::ButtonClearClick(TObject *Sender)
{
    MemoSource->Text = "";
	GridLexems->RowCount = 1;
    GridIdentifiers->RowCount = 1;
    GridConstants->RowCount = 1;
    StatusBar->SimpleText = "Cleared";
}

void __fastcall TMainForm::ButtonAnalyzeClick(TObject *Sender)
{
    if (MemoSource->Text.IsEmpty()) {
        ShowMessage("Enter source code for analysis");
        return;
    }

	AnsiString source = MemoSource->Text;
//	const wchar_t sourceCode[] = source.c_str();
	wchar_t sourceCode[100];
	mbstowcs(sourceCode, source.c_str()), 100);
    lexer->analyze(sourceCode);

    DisplayResults();

    StatusBar->SimpleText = "Analysis complete. Lexems found: " +
                           UnicodeString(lexer->getLexemCount());
}

void TMainForm::DisplayResults()
{
    GridLexems->RowCount = lexer->getLexemCount() + 1;

	for (int i = 0; i < lexer->getLexemCount(); i++) {
		Lexem* lex = lexer->getLexem(i);

        GridLexems->Cells[0][i + 1] = i + 1;
		GridLexems->Cells[1][i + 1] = lex->value;
        GridLexems->Cells[2][i + 1] = GetClassName(lex->classId);
        GridLexems->Cells[3][i + 1] = UnicodeString(lex->line) + ":" +
                                      UnicodeString(lex->position);
	}

	GridIdentifiers->RowCount = lexer->getIdentifierCount() + 1;

    for (int i = 0; i < lexer->getIdentifierCount(); i++) {
        TableEntry* entry = lexer->getIdentifier(i);

        GridIdentifiers->Cells[0][i + 1] = i + 1;
        GridIdentifiers->Cells[1][i + 1] = UnicodeString(entry->name);
        GridIdentifiers->Cells[2][i + 1] = "Variable";
        GridIdentifiers->Cells[3][i + 1] = entry->isUsed ? "Yes" : "No";
    }

    GridConstants->RowCount = lexer->getConstantCount() + 1;

    for (int i = 0; i < lexer->getConstantCount(); i++) {
        TableEntry* entry = lexer->getConstant(i);

        GridConstants->Cells[0][i + 1] = i + 1;
        GridConstants->Cells[1][i + 1] = UnicodeString(entry->name);
        GridConstants->Cells[2][i + 1] = entry->intValue;
        GridConstants->Cells[3][i + 1] = entry->isUsed ? "Yes" : "No";
    }
}


